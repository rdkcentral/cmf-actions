name: Test Commit Message Validator

on:
  push:
    branches: [ main, develop, CMFSUPPORT-* ]
    paths:
      - 'actions/validate-commit-messages/**'
      - '.github/workflows/test-validate-commit-messages.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'actions/validate-commit-messages/**'
      - '.github/workflows/test-validate-commit-messages.yml'
  workflow_dispatch:

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Native test runner requires Node 18+

      - name: Run validator unit tests
        working-directory: actions/validate-commit-messages
        run: node --test validator.test.js

      - name: Run strategy validation tests
        working-directory: actions/validate-commit-messages/strategies
        run: node --test strategies.test.js

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit access

      - name: Test action with rdkb strategy
        uses: ./actions/validate-commit-messages
        with:
          strategy: rdkb
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-ref: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head-ref: ${{ github.event.pull_request.head.sha || 'HEAD' }}
          fail-on-error: false  # Don't fail integration test on validation errors

      - name: Test action with conventional strategy
        uses: ./actions/validate-commit-messages
        with:
          strategy: conventional
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-ref: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head-ref: ${{ github.event.pull_request.head.sha || 'HEAD' }}
          fail-on-error: false

      - name: Test action with semantic-release strategy
        uses: ./actions/validate-commit-messages
        with:
          strategy: semantic-release
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-ref: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head-ref: ${{ github.event.pull_request.head.sha || 'HEAD' }}
          fail-on-error: false

      - name: Test strategy loading error handling
        id: test-invalid-strategy
        continue-on-error: true
        uses: ./actions/validate-commit-messages
        with:
          strategy: nonexistent-strategy
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-ref: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head-ref: ${{ github.event.pull_request.head.sha || 'HEAD' }}
          fail-on-error: true

      - name: Verify error handling worked
        if: steps.test-invalid-strategy.outcome != 'failure'
        run: |
          echo "‚ùå Expected action to fail with invalid strategy"
          exit 1
